#!/bin/sh
# Acode专用chsh工具：通过替换/bin/bash链接修改默认shell
# 已测试版本：1.11.6-beta.2

# 必须由root用户运行，防止意外
if [ "$(id -u)" -ne 0 ]; then
    echo "chsh: Error: Must run as root" >&2
    exit 1
fi

# 显示帮助信息
if [ $# -eq 0 ]; then
    echo "Usage:"
    echo "  chsh <shell_name>"
    echo "  chsh [-p | --path] <shell_path>"
    echo
    echo "Example: chsh zsh"
    exit 1
fi

# 备份 bash
[ ! -L /bin/bash ] && cp -lf /bin/bash /bin/real_bash 2>/dev/null

if [ ! -f /bin/real_bash ]; then
    echo "chsh: Error: Failed to backup /bin/bash" >&2
    exit 1
fi

NAME="$1"

if [ "$NAME" == "-p" ] || [ "$NAME" == "--path" ]; then
    if [ $# -eq 1 ]; then
        echo "chsh: Error: no path input" >&2
        exit 1
    fi
    SHELL_PATH="$2"
elif [ "$NAME" == "bash" ]; then
    cp -lf /bin/real_bash /bin/bash # 恢复原来的bash
    echo "changed back to bash"
    exit 0
else
    SHELL_PATH=$(which $NAME)
fi

# 防止意外行为
if [ "$SHELL_PATH" == "/bin/bash" ]; then
    echo "chsh: Error: cannot use this path" >&2
    exit 1
fi

# 验证shell是否在/etc/shells中
if ! grep -qFx "$SHELL_PATH" /etc/shells ; then
    echo "chsh: Error: '$SHELL_PATH' is not a valid login shell" >&2
    echo "chsh: see all valid shells in /etc/shells" >&2
    exit 1
fi

mkdir -p ~/.cache/chsh
mv /bin/bash ~/.cache/chsh/last_shell

if ! ln -sf "$SHELL_PATH" /bin/bash ; then
    echo "chsh: Error: Failed to create symlink, restoring..." >&2
    mv ~/.cache/chsh/last_shell /bin/bash
    exit 1
fi

rm ~/.cache/chsh/last_shell

echo "changed to $SHELL_PATH"